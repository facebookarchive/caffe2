<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Caffe2 - Python API: caffe2/python/tutorials/py_gen/Image_Pre-Processing_Pipeline.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="/static/favicon.png" type="image/x-icon">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo" width="56"><a href="/"><img alt="Logo" src="Caffe2-with-name-55-tall.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Caffe2 - Python API
   </div>
   <div id="projectbrief">A deep learning, cross platform ML framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="/doxygen-c/html/classes.html"><span>C++&#160;API</span></a></li>
      <li><a href="/doxygen-python/html/annotated.html"><span>Python&#160;API</span></a></li>
      <li><a href="https://github.com/caffe2/caffe2"><span>GitHub</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_20697b8f204bdfcab31e6b1a416f3ab8.html">caffe2</a></li><li class="navelem"><a class="el" href="dir_f4fda25fc5253eea1ed54677ae5fa2de.html">python</a></li><li class="navelem"><a class="el" href="dir_97a8e4938fab5a0841bdb9cd8076985e.html">tutorials</a></li><li class="navelem"><a class="el" href="dir_38e1d20e965e77ed1a3671bbc2942034.html">py_gen</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Image_Pre-Processing_Pipeline.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#########################################################</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"># DO NOT EDIT THIS FILE. IT IS GENERATED AUTOMATICALLY. #</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"># PLEASE LOOK INTO THE README FOR MORE INFORMATION.     #</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">#########################################################</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"># coding: utf-8</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"># # Image Loading and Preprocessing</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"># In this tutorial we&#39;re going to look at how we can load in images from a local file or a URL which you can then utilize in other tutorials or examples. Also, we&#39;re going to go in depth on the kinds of preprocessing that is necessary to utilize Caffe2 with images.</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"># #### Mac OSx Prerequisites</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"># If you don&#39;t already have these Python modules installed you&#39;ll need to do that now.</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"># ```</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"># sudo pip install scikit-image scipy matplotlib</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"># ```</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"># In[1]:</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">import</span> skimage</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">import</span> skimage.io <span class="keyword">as</span> io</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">import</span> skimage.transform </div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">import</span> sys</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> math</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> matplotlib.image <span class="keyword">as</span> mpimg</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;print(<span class="stringliteral">&quot;Required modules imported.&quot;</span>)</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"># ## Test an Image</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"># In the code block below use IMAGE_LOCATION to load what you would like to test. Just change the comment flags to go through each round of the Tutorial. In this way, you&#39;ll get to see what happens with a variety of image formats and some tips on how you might preprocess them. If you want to try your own image, drop it in the images folder or use a remote URL. When you pick a remote URL, make it easy on yourself and try to find a URL that points to a common image file type and extension versus some long identifier or query string which might just break this next step.</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"># ## Color Issues</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"># Keep in mind when you load images from smartphone cameras that you may run into color formatting issues. Below we show an example of how flipping between RGB and BGR can impact an image. This would obviously throw off detection in your model. Make sure the image data you&#39;re passing around is what you think it is!</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"># ### Caffe Uses BGR Order</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"># Due to legacy support of OpenCV in Caffe and how it handles images in Blue-Green-Red (BGR) order instead of the more commonly used Red-Green-Blue (RGB) order, Caffe2 also expects **BGR** order. In many ways this decision helps in the long run as you use different computer vision utilities and libraries, but it also can be the source of confusion. </span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"># In[2]:</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"># You can load either local IMAGE_FILE or remote URL</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"># For Round 1 of this tutorial, try a local image.</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;IMAGE_LOCATION = <span class="stringliteral">&#39;images/cat.jpg&#39;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"># For Round 2 of this tutorial, try a URL image with a flower: </span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://cdn.pixabay.com/photo/2015/02/10/21/28/flower-631765_1280.jpg&quot;</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;images/flower.jpg&quot;</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment"># For Round 3 of this tutorial, try another URL image with lots of people:</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://upload.wikimedia.org/wikipedia/commons/1/18/NASA_Astronaut_Group_15.jpg&quot;</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;images/astronauts.jpg&quot;</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment"># For Round 4 of this tutorial, try a URL image with a portrait!</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://upload.wikimedia.org/wikipedia/commons/9/9a/Ducreux1.jpg&quot;</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;images/Ducreux.jpg&quot;</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;img = skimage.img_as_float(skimage.io.imread(IMAGE_LOCATION)).astype(np.float32)</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment"># test color reading</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment"># show the original image</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;pyplot.figure()</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;pyplot.subplot(1,2,1)</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;pyplot.imshow(img)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;pyplot.title(<span class="stringliteral">&#39;Original image = RGB&#39;</span>)</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"># show the image in BGR - just doing RGB-&gt;BGR temporarily for display</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;imgBGR = img[:, :, (2, 1, 0)]</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">#pyplot.figure()</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;pyplot.subplot(1,2,2)</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;pyplot.imshow(imgBGR)</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;pyplot.title(<span class="stringliteral">&#39;OpenCV, Caffe2 = BGR&#39;</span>)</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment"># As you can see in the example above, the difference in order is very important to keep in mind. In the code block below we&#39;ll be taking the image and converting to BGR order for Caffe to process it appropriately.</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"># But wait, there&#39;s more color fun...</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment"># ### Caffe Prefers CHW Order</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment"># Now what!? What&#39;s CHW, you ask? Well, there&#39;s also HWC! Both formats come up in image processing.</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment"># - H: Height</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment"># - W: Width</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment"># - C: Channel (as in color)</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment"># Digging even deeper into how image data can be stored is the memory allocation order. You might have noticed when we first loaded the image that we forced it through some interesting transformations. These were data transformations that let us play with the image as if it were a cube. What we see is on top of the cube, and manipulating the layers below can change what we view. We can tinker with it&#39;s underlying properties and as you saw above, swap colors quite easily. </span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment"># For GPU processing, which is what Caffe2 excels at, this order needs to be CHW. For CPU processing, this order is generally HWC. Essentially, you&#39;re going to want to use CHW and make sure that step is included in your image pipeline. Tweak RGB to be BGR, which is encapsulated as this &quot;C&quot; payload, then tweak HWC, the &quot;C&quot; being the very same colors you just switched around.</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"># You may ask why! And the reason points to cuDNN which is what helps accelerate processing on GPUs. It uses only CHW, and we&#39;ll sum it up by saying it is faster. </span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"># Give these two transformations, you might think that&#39;s enough, but it isn&#39;t. We still need to resize and/or crop and potentially look at things like orientation (rotation) and mirroring.</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"># ## Rotation and Mirroring</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment"># This topic is usually reserved for images that are coming from a smart phone. Phones, in general, take great pictures, but do a horrible job communicating how the image was taken and what orientation it should be in. Then there&#39;s the user who does everything under the sun with their phone&#39;s cameras, making them do things its designer never expected. Cameras - right, because there are often two cameras and these two cameras take different sized pictures in both pixel count and aspect ratio, and not only that, they sometimes take them mirrored, and they sometimes take them in portrait and landscape modes, and sometimes they don&#39;t bother to tell which mode they were in. </span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"># In many ways this is the first thing you need to evaluate in your pipeline, then look at sizing (described below), then figure out the color situation. If you&#39;re developing for iOS, then you&#39;re in luck, it&#39;s going to be relatively easy. If you&#39;re a super-hacker wizard developer with lead-lined shorts and developing for Android, then at least you have lead-lined shorts. </span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"># The variability in the Android marketplace is wonderful and horrifying. In an ideal world, you could rely on the EXIF data in pictures coming from any camera and use that to decide orientation and mirroring and you&#39;d have one simple case function to handle your transformations. No such luck, but you&#39;re not alone. Many have come before you and suffered for you.</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment"># ### Library for Handling Mobile Images</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment"># Hooray! We&#39;re going to give you something to ease your pain. These are not full-proof. Users can and will defy you and every other developers&#39; best attempts to handle their images. Here we&#39;ll link to some resources that can be used depending on the platform.</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment"># Image Preprocessing Libraries and/or Snippits</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment"># - [iOS](#)</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment"># - [Android](#)</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment"># - [Python](#)</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment"># In the meantime though, let&#39;s play with some images and show the basics for manipulations that you might need to do.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"># In[3]:</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment"># Image came in sideways - it should be a portait image!</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment"># How you detect this depends on the platform</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment"># Could be a flag from the camera object</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment"># Could be in the EXIF data</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment"># ROTATED_IMAGE = &quot;https://upload.wikimedia.org/wikipedia/commons/8/87/Cell_Phone_Tower_in_Ladakh_India_with_Buddhist_Prayer_Flags.jpg&quot;</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;ROTATED_IMAGE = <span class="stringliteral">&quot;images/cell-tower.jpg&quot;</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;imgRotated = skimage.img_as_float(skimage.io.imread(ROTATED_IMAGE)).astype(np.float32)</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;pyplot.figure()</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;pyplot.imshow(imgRotated)</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;pyplot.title(<span class="stringliteral">&#39;Rotated image&#39;</span>)</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment"># Image came in flipped or mirrored - text is backwards!</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment"># Again detection depends on the platform</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"># This one is intended to be read by drivers in their rear-view mirror</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment"># MIRROR_IMAGE = &quot;https://upload.wikimedia.org/wikipedia/commons/2/27/Mirror_image_sign_to_be_read_by_drivers_who_are_backing_up_-b.JPG&quot;</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;MIRROR_IMAGE = <span class="stringliteral">&quot;images/mirror-image.jpg&quot;</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;imgMirror = skimage.img_as_float(skimage.io.imread(MIRROR_IMAGE)).astype(np.float32)</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;pyplot.figure()</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;pyplot.imshow(imgMirror)</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;pyplot.title(<span class="stringliteral">&#39;Mirror image&#39;</span>)</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment"># So you can see that we kind of have some problems. If we&#39;re detecting places, landmarks, or objects, a sideways cell tower is no good. If we&#39;re detecting text and doing automatic language translation, then mirrored text is no good. But hey, maybe you want to make a model that can detect English both ways. That would be awesome, but not for this tutorial!</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"># Let&#39;s transform these babies into something Caffe2 and the standard detection models we have around can detect. Also, this little trick might save you if, say for example, you really had to detect the cell tower but there&#39;s no EXIF data to be found: then you&#39;d cycle through every rotation, and every flip, spawning many derivatives of this photo and run them all through. When the percentage of confidence of detection is high enough, Bam!, you found the orientation you needed and that sneaky cell tower.</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"># Anyway, to the example code:</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"># In[4]:</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment"># Run me to flip the image back and forth</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;imgMirror = np.fliplr(imgMirror)</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;pyplot.figure()</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;pyplot.imshow(imgMirror)</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;pyplot.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;pyplot.title(<span class="stringliteral">&#39;Mirror image&#39;</span>)</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment"># In[5]:</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment"># Run me to rotate the image 90 degrees</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;imgRotated = np.rot90(imgRotated)</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;pyplot.figure()</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;pyplot.imshow(imgRotated)</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;pyplot.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;pyplot.title(<span class="stringliteral">&#39;Rotated image&#39;</span>)</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment"># ## Sizing</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment"># Part of preprocessing is resizing. For reasons we won&#39;t get into here, images in the Caffe2 pipeline should be square. Also, to help with performance, they should be resized to a standard height and width which is usually going to be smaller than your original source. In the example below we&#39;re resizing to 256 x 256 pixels, however you might notice that the `input_height` and `input_width` is set to 224 x 224 which is then used to specify the crop. This is what several image-based models are expecting. They were trained on images sized to 224 x 224 and in order for the model to properly identify the suspect images you throw at it, these should also be 224 x 224.</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment"># ** Make sure you double-check the input sizes for the model you&#39;re using!**</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment"># In[6]:</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment"># Model is expecting 224 x 224, so resize/crop needed.</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment"># Here are the steps we use to preprocess the image.</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment"># (1) Resize the image to 256*256, and crop out the center.</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;input_height, input_width = 224, 224</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;print(<span class="stringliteral">&quot;Model&#39;s input shape is %dx%d&quot;</span>) % (input_height, input_width)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">#print(&quot;Original image is %dx%d&quot;) % (skimage.)</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;img256 = skimage.transform.resize(img, (256, 256))</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;pyplot.figure()</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;pyplot.imshow(img256)</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;pyplot.title(<span class="stringliteral">&#39;Resized image to 256x256&#39;</span>)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;print(<span class="stringliteral">&quot;New image shape:&quot;</span> + str(img256.shape))</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment"># Note the resizing has distorted the image a little bit. It is important to recognize this effect during your processing as it can have an effect on the results of your model. Flowers and animals might be ok with a little stretching or squeezing, but facial features may not. </span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment"># This can happen when the dimensions of the original image are not proportionally exact to your desired size. In this particular example it would have been better to just resize to 224x224 and not bother cropping. Let&#39;s try another strategy of rescaling the image and maintaining the aspect ratio.</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment"># ### Rescaling</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment"># If you imagine portait images versus landscape images you&#39;ll know that there are a lot of things that can get messed up by doing a slopping resize. Rescaling is assuming that you&#39;re locking down the aspect ratio to prevent distortion in the image. In this case, we&#39;ll scale down the image to the shortest side that matches with the model&#39;s input size.</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment"># In our example here, the model size is 224 x 224. As you look at your monitor in 1920x1080, it is longer in width than height and if you shrunk it down to 224, you&#39;d run out of height before you ran out of width, so...</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment"># - Landscape: limit resize by the height</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment"># - Portrait: limit resize by the width</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment"># In[7]:</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;print(<span class="stringliteral">&quot;Original image shape:&quot;</span> + str(img.shape) + <span class="stringliteral">&quot; and remember it should be in H, W, C!&quot;</span>)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;print(<span class="stringliteral">&quot;Model&#39;s input shape is %dx%d&quot;</span>) % (input_height, input_width)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;aspect = img.shape[1]/float(img.shape[0])</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;print(<span class="stringliteral">&quot;Orginal aspect ratio: &quot;</span> + str(aspect))</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;if(aspect&gt;1):</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment"># landscape orientation - wide image</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    res = int(aspect * input_height)</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    imgScaled = skimage.transform.resize(img, (input_height, res))</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;if(aspect&lt;1):</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment"># portrait orientation - tall image</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    res = int(input_width/aspect)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    imgScaled = skimage.transform.resize(img, (res, input_width))</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;if(aspect == 1):</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    imgScaled = skimage.transform.resize(img, (input_height, input_width))</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;pyplot.figure()</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;pyplot.imshow(imgScaled)</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;pyplot.title(<span class="stringliteral">&#39;Rescaled image&#39;</span>)</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;print(<span class="stringliteral">&quot;New image shape:&quot;</span> + str(imgScaled.shape) + <span class="stringliteral">&quot; in HWC&quot;</span>)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment"># At this point only one dimension is set to what the model&#39;s input requires. We still need to crop one side to make a square. </span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment"># ### Cropping</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment"># There are a variety of strategies we could utilize. In fact, we could backpeddle and decide to do a center crop. So instead of scaling down to the smallest we could get on at least one side, we take a chunk out of the middle. If we had done that without scaling we would have ended up with just part of a flower pedal, so we still needed some resizing of the image.</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment"># Below we&#39;ll try a few strategies for cropping:</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment"># 1. Just grab the exact dimensions you need from the middle!</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment"># 2. Resize to a square that&#39;s pretty close then grab from the middle.</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment"># 3. Use the rescaled image and grab the middle.</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment"># In[8]:</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment"># Compare the images and cropping strategies</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment"># Try a center crop on the original for giggles</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;print(<span class="stringliteral">&quot;Original image shape:&quot;</span> + str(img.shape) + <span class="stringliteral">&quot; and remember it should be in H, W, C!&quot;</span>)</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="keyword">def </span>crop_center(img,cropx,cropy):</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    y,x,c = img.shape</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    startx = x//2-(cropx//2)</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    starty = y//2-(cropy//2)    </div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">return</span> img[starty:starty+cropy,startx:startx+cropx]</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment"># yes, the function above should match resize and take a tuple...</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;pyplot.figure()</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment"># Original image</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;imgCenter = crop_center(img,224,224)</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;pyplot.subplot(1,3,1)</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;pyplot.imshow(imgCenter)</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;pyplot.title(<span class="stringliteral">&#39;Original&#39;</span>)</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment"># Now let&#39;s see what this does on the distorted image</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;img256Center = crop_center(img256,224,224)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;pyplot.subplot(1,3,2)</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;pyplot.imshow(img256Center)</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;pyplot.title(<span class="stringliteral">&#39;Squeezed&#39;</span>)</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment"># Scaled image</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;imgScaledCenter = crop_center(imgScaled,224,224)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;pyplot.subplot(1,3,3)</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;pyplot.imshow(imgScaledCenter)</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;pyplot.title(<span class="stringliteral">&#39;Scaled&#39;</span>)</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment"># As you can see that didn&#39;t work out so well, except for maybe the last one. The middle one may be just fine too, but you won&#39;t know until you try on the model and test a lot of candidate images.</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment"># At this point we can look at the difference we have, split it in half and remove some pixels from each side. This does have a drawback, however, as an off-center subject of interest would get clipped.</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment"># If you&#39;ve run this tutorial a few times now and are on Round 3, you&#39;ll notice a pretty big problem. You&#39;re missing astronaughts! You can still see the issue with the flower from Round 2 as well. Things are missing after the cropping and that could cause you problems. Think of it this way: if you don&#39;t know how the model you&#39;re using was prepared then you don&#39;t know how to conform your images, so take care to test results! If the model used a lot of different aspect ratio images and just squeezed them to conform to a square then there&#39;s a good chance that over time and lots of samples it &quot;learned&quot; what things look like squeezed and can make a match. However, if you&#39;re looking for details like facial features and landmarks, or really nuanced elements in any image, this could be dangerous and error-prone. </span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment"># #### Further Strategies?</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment"># Another strategy would be to rescale to the best size you can, with real data, but then pad the rest of the image with information that you can safely ignore in your model. We&#39;ll save that for another tutorial though since you&#39;ve been through enough here! </span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment"># ### Upscaling</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment"># What do you do when the images you want to run are &quot;tiny&quot;? In our example we&#39;ve been prepping for Input Images with the spec of 224x224. Consider this 128x128 image below.</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment"># ![cells at 128x128](images/Cellsx128.png)</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment"># Now we&#39;re not talking about super-resolution or the CSI-effect where we can take blurry ATM photos and identify the tattoo an a perp&#39;s neck. Although, there are [some advances](https://github.com/david-gpu/srez) along these lines that deep learning has provided, and if you&#39;re reading this in time (before 3/1/17), go [check this out](https://developer.nvidia.com/zoom-enhance-magic-image-upscaling-using-deep-learning). What we want to do is simple, but, like cropping, it does have a variety of strategies you should consider.</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment"># The most basic approach is going from a small square to a bigger square and using the defauls skimage provides for you. This `resize` method defaults the interpolation order parameter to 1 which happens to be bi-linear if you even cared, but it is worth mentioning because these might be the fine-tuning knobs you need later to fix problems, such as strange visual artifacts, that can be introduced in upscaling images.</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment"># In[9]:</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;imgTiny = <span class="stringliteral">&quot;images/Cellsx128.png&quot;</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;imgTiny = skimage.img_as_float(skimage.io.imread(imgTiny)).astype(np.float32)</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Original image shape: &quot;</span>, imgTiny.shape</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;imgTiny224 = skimage.transform.resize(imgTiny, (224, 224))</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Upscaled image shape: &quot;</span>, imgTiny224.shape</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment"># Plot original</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;pyplot.figure()</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;pyplot.subplot(1, 2, 1)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;pyplot.imshow(imgTiny)</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;pyplot.title(<span class="stringliteral">&#39;128x128&#39;</span>)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment"># Plot upscaled</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;pyplot.subplot(1, 2, 2)</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;pyplot.imshow(imgTiny224)</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;pyplot.title(<span class="stringliteral">&#39;224x224&#39;</span>)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment"># Great, it worked!. You can see in the shape outputs that you had (128, 128, 4) and you received (224, 224, 4). Wait a minute! 4? In every example so far the last value in shape has been 3! When we used a png file we entered a new reality; one where transparency is possible. This 4th value describes opacity, or transparency, depending if you&#39;re a half-glass-empty type. Anyway, we can handle it just fine, but keep an eye on that number.</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment"># It&#39;s appropriate to put this discussion towards the end, but before we do further manipulations to the image, it&#39;s data order, and its overall payload. You can really mess up your data and the image if you do a simple resample on the image in its current format. Remember that it is currently a cube of data and that there&#39;s more going on in there right now than just Red, Green, and Blue (and opacity). Depending on when you decide to resize you&#39;ll have to account for that extra data.</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment"># Let&#39;s break stuff! Try upscaling the image after you&#39;ve switched the image to CHW.</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment"># In[10]:</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;imgTiny = <span class="stringliteral">&quot;images/Cellsx128.png&quot;</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;imgTiny = skimage.img_as_float(skimage.io.imread(imgTiny)).astype(np.float32)</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Image shape before HWC --&gt; CHW conversion: &quot;</span>, imgTiny.shape</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment"># swapping the axes to go from HWC to CHW</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment"># uncomment the next line and run this block!</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;imgTiny = imgTiny.swapaxes(1, 2).swapaxes(0, 1)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Image shape after HWC --&gt; CHW conversion: &quot;</span>, imgTiny.shape</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;imgTiny224 = skimage.transform.resize(imgTiny, (224, 224))</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Image shape after resize: &quot;</span>, imgTiny224.shape</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment"># we know this is going to go wrong, so...</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="comment"># Plot original</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    pyplot.figure()</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    pyplot.subplot(1, 2, 1)</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    pyplot.imshow(imgTiny)</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    pyplot.title(<span class="stringliteral">&#39;128x128&#39;</span>)</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordflow">except</span>:</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">print</span> <span class="stringliteral">&quot;Here come bad things!&quot;</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment"># hands up if you want to see the error (uncomment next line)</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="comment">#raise </span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment"># Epic fail, right? If you let the code block above swap the axes, then resize the image, you will see this output:</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment"># `Image shape after resize:  (224, 224, 128)`</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment"># Now you have 128 where you should still have 4. Oops. Let&#39;s revert in the code block below and try something else. We&#39;ll show an example where the image is smaller than your Input specification, and not square. Like maybe it came from a new microscope that can only take imagery in rectangular bands.</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment"># In[11]:</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;imgTiny = <span class="stringliteral">&quot;images/Cellsx128.png&quot;</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;imgTiny = skimage.img_as_float(skimage.io.imread(imgTiny)).astype(np.float32)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;imgTinySlice = crop_center(imgTiny, 128, 56)</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment"># Plot original</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;pyplot.figure()</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;pyplot.subplot(2, 1, 1)</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;pyplot.imshow(imgTiny)</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;pyplot.title(<span class="stringliteral">&#39;Original&#39;</span>)</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment"># Plot slice</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;pyplot.figure()</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;pyplot.subplot(2, 2, 1)</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;pyplot.imshow(imgTinySlice)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;pyplot.title(<span class="stringliteral">&#39;128x56&#39;</span>)</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment"># Upscale?</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Slice image shape: &quot;</span>, imgTinySlice.shape</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;imgTiny224 = skimage.transform.resize(imgTinySlice, (224, 224))</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Upscaled slice image shape: &quot;</span>, imgTiny224.shape</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment"># Plot upscaled</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;pyplot.subplot(2, 2, 2)</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;pyplot.imshow(imgTiny224)</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;pyplot.axis(<span class="stringliteral">&#39;on&#39;</span>)</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;pyplot.title(<span class="stringliteral">&#39;224x224&#39;</span>)</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment"># Alright, this was a bit of a stretch for an example of how upscaling can fail. Get it? Stretch? This could be a life-or-death kind of failure though. What if normal cells are circular and diseased cells are elongated and bent? Sickle cell anemia for example: </span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment"># ![sickle cells example](images/sickle-cells.jpg)</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment"># In this situation, what do you do? It really depends on the model and how it was trained. In some cases it may be ok to pad the rest of the image with white, or maybe black, or maybe noise, or maybe even use png and transparencies and set a mask for the images so the model ignores transparent areas. See how much fun you can have figuring this out and you get to make medical breakthroughs too!</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment"># Let&#39;s move on to the last step which we&#39;ve already mentioned and that is to adjust the image input to be in BGR order. There&#39;s also another feature that Caffe2 uses, which is a `batch term`. We&#39;ve already talked about CHW. This is the N, for number of images in NCHW.</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment"># ### Final Preprocessing and the Batch Term</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment"># In the last steps below we are going to switch the image&#39;s data order to BGR, stuff that into the Color column, then reoder the columns for GPU processing (HCW--&gt;CHW) and then add a fourth dimension (N) to the image to track the number of images. In theory, you can just keep adding dimensions to your data, but this one is required for Caffe2 as it relays to Caffe how many images to expect in this batch. We set it to one (1) to indicate there&#39;s only one image going into Caffe in this batch. Note that in the final output when we check `img.shape` the order is quite different. We&#39;ve added N for number of images, and changed the order like so: `N, C, H, W`</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment"># In[12]:</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment"># this next line helps with being able to rerun this section</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment"># if you want to try the outputs of the different crop strategies above</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment"># swap out imgScaled with img (original) or img256 (squeezed)</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;imgCropped = crop_center(imgScaled,224,224)</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Image shape before HWC --&gt; CHW conversion: &quot;</span>, imgCropped.shape</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment"># (1) Since Caffe expects CHW order and the current image is HWC,</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">#     we will need to change the order.</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;imgCropped = imgCropped.swapaxes(1, 2).swapaxes(0, 1)</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Image shape after HWC --&gt; CHW conversion: &quot;</span>, imgCropped.shape</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;pyplot.figure()</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3):</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="comment"># For some reason, pyplot subplot follows Matlab&#39;s indexing</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    <span class="comment"># convention (starting with 1). Well, we&#39;ll just follow it...</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    pyplot.subplot(1, 3, i+1)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    pyplot.imshow(imgCropped[i])</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    pyplot.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    pyplot.title(<span class="stringliteral">&#39;RGB channel %d&#39;</span> % (i+1))</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment"># (2) Caffe uses a BGR order due to legacy OpenCV issues, so we</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">#     will change RGB to BGR.</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;imgCropped = imgCropped[(2, 1, 0), :, :]</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&quot;Image shape after BGR conversion: &quot;</span>, imgCropped.shape</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment"># for discussion later - not helpful at this point</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment"># (3) We will subtract the mean image. Note that skimage loads</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">#     image in the [0, 1] range so we multiply the pixel values</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">#     first to get them into [0, 255].</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">#mean_file = os.path.join(CAFFE_ROOT, &#39;python/caffe/imagenet/ilsvrc_2012_mean.npy&#39;)</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">#mean = np.load(mean_file).mean(1).mean(1)</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">#img = img * 255 - mean[:, np.newaxis, np.newaxis]</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;pyplot.figure()</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3):</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="comment"># For some reason, pyplot subplot follows Matlab&#39;s indexing</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment"># convention (starting with 1). Well, we&#39;ll just follow it...</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    pyplot.subplot(1, 3, i+1)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    pyplot.imshow(imgCropped[i])</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    pyplot.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    pyplot.title(<span class="stringliteral">&#39;BGR channel %d&#39;</span> % (i+1))</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="comment"># (4) finally, since caffe2 expect the input to have a batch term</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="comment">#     so we can feed in multiple images, we will simply prepend a</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="comment">#     batch dimension of size 1. Also, we will make sure image is</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="comment">#     of type np.float32.</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;imgCropped = imgCropped[np.newaxis, :, :, :].astype(np.float32)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keywordflow">print</span> <span class="stringliteral">&#39;Final input shape is:&#39;</span>, imgCropped.shape</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment"># In the output above you should note these alterations:</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment"># 1. Before and after of the HWC to CHW change. The 3, which is the number of color channels moved to the beginning.</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment"># 2. In the pictures above you can see that the color order was switched too. RGB became BGR. Blue and Red switched places.</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment"># 3. The final input shape, meaning the last change to the image was to add the batch field to the beginning, so that now you have (1, 3, 224, 224) for: </span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">#     - 1 image in the batch, </span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">#     - 3 color channels (in BGR), </span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">#     - 224 height, </span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">#     - 224 width.</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div></div><!-- fragment --></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Mar 19 2018 13:12:32 for Caffe2 - Python API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
<div class="footerContainer">
  <div id="footer_wrap" class="wrapper footerWrapper">
    <div class="footerBlocks">
      <div id="fb_oss" class="footerSection fbOpenSourceFooter">
          <svg class="facebookOSSLogoSvg" viewBox="0 0 1133.9 1133.9" x="0px" y="0px" height=50 width=50>
            <g>
              <path class="logoRing outerRing" d="M 498.3 3.7 c 153.6 88.9 307.3 177.7 461.1 266.2 c 7.6 4.4 10.3 9.1 10.3 17.8 c -0.3 179.1 -0.2 358.3 0 537.4 c 0 8.1 -2.4 12.8 -9.7 17.1 c -154.5 88.9 -308.8 178.1 -462.9 267.5 c -9 5.2 -15.5 5.3 -24.6 0.1 c -153.9 -89.2 -307.9 -178 -462.1 -266.8 C 3 838.8 0 833.9 0 825.1 c 0.3 -179.1 0.2 -358.3 0 -537.4 c 0 -8.6 2.6 -13.6 10.2 -18 C 164.4 180.9 318.4 92 472.4 3 C 477 -1.5 494.3 -0.7 498.3 3.7 Z M 48.8 555.3 c 0 79.9 0.2 159.9 -0.2 239.8 c -0.1 10 3 15.6 11.7 20.6 c 137.2 78.8 274.2 157.8 411 237.3 c 9.9 5.7 17 5.7 26.8 0.1 c 137.5 -79.8 275.2 -159.2 412.9 -238.5 c 7.4 -4.3 10.5 -8.9 10.5 -17.8 c -0.3 -160.2 -0.3 -320.5 0 -480.7 c 0 -8.8 -2.8 -13.6 -10.3 -18 C 772.1 218 633.1 137.8 494.2 57.4 c -6.5 -3.8 -11.5 -4.5 -18.5 -0.5 C 336.8 137.4 197.9 217.7 58.8 297.7 c -7.7 4.4 -10.2 9.2 -10.2 17.9 C 48.9 395.5 48.8 475.4 48.8 555.3 Z" />
              <path class="logoRing middleRing" d="M 184.4 555.9 c 0 -33.3 -1 -66.7 0.3 -100 c 1.9 -48 24.1 -86 64.7 -110.9 c 54.8 -33.6 110.7 -65.5 167 -96.6 c 45.7 -25.2 92.9 -24.7 138.6 1 c 54.4 30.6 108.7 61.5 162.2 93.7 c 44 26.5 67.3 66.8 68 118.4 c 0.9 63.2 0.9 126.5 0 189.7 c -0.7 50.6 -23.4 90.7 -66.6 116.9 c -55 33.4 -110.8 65.4 -167.1 96.5 c -43.4 24 -89 24.2 -132.3 0.5 c -57.5 -31.3 -114.2 -64 -170 -98.3 c -41 -25.1 -62.9 -63.7 -64.5 -112.2 C 183.5 621.9 184.3 588.9 184.4 555.9 Z M 232.9 556.3 c 0 29.5 0.5 59.1 -0.1 88.6 c -0.8 39.2 16.9 67.1 50.2 86.2 c 51.2 29.4 102.2 59.2 153.4 88.4 c 31.4 17.9 63.6 18.3 95 0.6 c 53.7 -30.3 107.1 -61.2 160.3 -92.5 c 29.7 -17.5 45 -44.5 45.3 -78.8 c 0.6 -61.7 0.5 -123.5 0 -185.2 c -0.3 -34.4 -15.3 -61.5 -44.9 -79 C 637.7 352.6 583 320.8 527.9 290 c -27.5 -15.4 -57.2 -16.1 -84.7 -0.7 c -56.9 31.6 -113.4 64 -169.1 97.6 c -26.4 15.9 -40.7 41.3 -41.1 72.9 C 232.6 491.9 232.9 524.1 232.9 556.3 Z" />
              <path class="logoRing innerRing" d="M 484.9 424.4 c 69.8 -2.8 133.2 57.8 132.6 132 C 617 630 558.5 688.7 484.9 689.1 c -75.1 0.4 -132.6 -63.6 -132.7 -132.7 C 352.1 485 413.4 421.5 484.9 424.4 Z M 401.3 556.7 c -3.4 37.2 30.5 83.6 83 84.1 c 46.6 0.4 84.8 -37.6 84.9 -84 c 0.1 -46.6 -37.2 -84.4 -84.2 -84.6 C 432.2 472.1 397.9 518.3 401.3 556.7 Z" />
            </g>
          </svg>
        <h2>Facebook Open Source</h2>
      </div>
      <div class="footerSection">
        <a class="footerLink" href="https://code.facebook.com/projects/" target="_blank">Open Source Projects</a>
        <a class="footerLink" href="https://github.com/facebook/" target="_blank">GitHub</a>
        <a class="footerLink" href="https://twitter.com/fbOpenSource" target="_blank">Twitter</a>
      </div>
      <div class="footerSection rightAlign">
        <a class="footerLink" href="https://github.com/caffe2/caffe2" target="_blank">Contribute to this project on GitHub</a>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript" src="/js/jekyll-link-anchors.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '{{ site.gacode }}', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
