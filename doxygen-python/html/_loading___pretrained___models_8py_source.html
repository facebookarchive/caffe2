<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Caffe2 - Python API: caffe2/python/tutorials/py_gen/Loading_Pretrained_Models.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="/static/favicon.png" type="image/x-icon">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
<link href="main.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo" width="56"><a href="/"><img alt="Logo" src="Caffe2-with-name-55-tall.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Caffe2 - Python API
   </div>
   <div id="projectbrief">A deep learning, cross platform ML framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="/doxygen-c/html/classes.html"><span>C++&#160;API</span></a></li>
      <li><a href="/doxygen-python/html/annotated.html"><span>Python&#160;API</span></a></li>
      <li><a href="https://github.com/caffe2/caffe2"><span>GitHub</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_20697b8f204bdfcab31e6b1a416f3ab8.html">caffe2</a></li><li class="navelem"><a class="el" href="dir_f4fda25fc5253eea1ed54677ae5fa2de.html">python</a></li><li class="navelem"><a class="el" href="dir_97a8e4938fab5a0841bdb9cd8076985e.html">tutorials</a></li><li class="navelem"><a class="el" href="dir_38e1d20e965e77ed1a3671bbc2942034.html">py_gen</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Loading_Pretrained_Models.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#########################################################</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"># DO NOT EDIT THIS FILE. IT IS GENERATED AUTOMATICALLY. #</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"># PLEASE LOOK INTO THE README FOR MORE INFORMATION.     #</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">#########################################################</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"># coding: utf-8</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"># # Loading Pre-Trained Models</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"># ## Description</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"># In this tutorial, we will use the pre-trained `squeezenet` model from the [ModelZoo](https://github.com/caffe2/caffe2/wiki/Model-Zoo) to classify our own images. As input, we will provide the path (or URL) to an image we want to classify. It will also be helpful to know the [ImageNet object code](https://gist.githubusercontent.com/aaronmarkham/cd3a6b6ac071eca6f7b4a6e40e6038aa/raw/9edb4038a37da6b5a44c3b5bc52e448ff09bfe5b/alexnet_codes) for the image so we can verify our results. The &#39;object code&#39; is nothing more than the integer label for the class used during training, for example &quot;985&quot; is the code for the class &quot;daisy&quot;. Note, although we are using squeezenet here, this tutorial serves as a somewhat universal method for running inference on pretrained models.</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"># If you came from the [Image Pre-Processing Tutorial](https://caffe2.ai/docs/tutorial-image-pre-processing.html), you will see that we are using rescale and crop functions to prep the image, as well as reformatting the image to be CHW, BGR, and finally NCHW. We also correct for the image mean by either using the calculated mean from a provided npy file, or statically removing 128 as a placeholder average.</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"># Hopefully, you will find that loading pre-trained models is simple and syntactically concise. From a high level, these are the three required steps for running inference on a pretrained model:</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"># 1. Read the init and predict protobuf (.pb) files of the pretrained model</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">#         with open(&quot;init_net.pb&quot;) as f:</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">#             init_net = f.read()</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">#         with open(&quot;predict_net.pb&quot;) as f:</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">#             predict_net = f.read()        </span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"># 2. Initialize a Predictor in your workspace with the blobs from the protobufs</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">#         p = workspace.Predictor(init_net, predict_net)</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"># 3. Run the net on some data and get the (softmax) results!</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">#         results = p.run({&#39;data&#39;: img})</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"># Note, assuming the last layer of the network is a softmax layer, the results come back as a multidimensional array of probabilities with length equal to the number of classes that the model was trained on. The probabilities may be indexed by the object code (integer type), so if you know the object code you can index the results array at that index to view the network&#39;s confidence that the input image is of that class.</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"># **Model Download Options**</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"># Although we will use `squeezenet` here, you can check out the [Model Zoo for pre-trained models](https://github.com/caffe2/caffe2/wiki/Model-Zoo) to browse/download a variety of pretrained models, or you can use Caffe2&#39;s `caffe2.python.models.download` module to easily acquire pre-trained models from [Github caffe2/models](http://github.com/caffe2/models). </span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"># For our purposes, we will use the `models.download` module to download `squeezenet` into the `/caffe2/python/models` folder of our local Caffe2 installation with the following command:</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"># ```</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"># python -m caffe2.python.models.download -i squeezenet</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment"># ```</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"># If the above download worked then you should have a directory named squeezenet in your `/caffe2/python/models` folder that contains `init_net.pb` and `predict_net.pb`. Note, if you do not use the `-i` flag, the model will be downloaded to your CWD, however it will still be a directory named squeezenet containing two protobuf files. Alternatively, if you wish to download all of the models, you can clone the entire repo using: </span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"># ```</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment"># git clone https://github.com/caffe2/models</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"># ```</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"># ## Code </span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"># Before we start, lets take care of the required imports.</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"># In[1]:</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> unicode_literals</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="keyword">from</span> caffe2.proto <span class="keyword">import</span> caffe2_pb2</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keyword">import</span> skimage.io</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">import</span> skimage.transform</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="keyword">import</span> os</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacecaffe2_1_1python.html">caffe2.python</a> <span class="keyword">import</span> core, workspace, models</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">import</span> urllib2</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="keyword">import</span> operator</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;print(<span class="stringliteral">&quot;Required modules imported.&quot;</span>)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment"># ### Inputs</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"># Here, we will specify the inputs to be used for this run, including the input image, the model location, the mean file (optional), the required size of the image, and the location of the label mapping file.</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment"># In[2]:</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment"># Configuration --- Change to your setup and preferences!</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment"># This directory should contain the models downloaded from the model zoo. To run this </span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">#   tutorial, make sure there is a &#39;squeezenet&#39; directory at this location that </span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">#   contains both the &#39;init_net.pb&#39; and &#39;predict_net.pb&#39;</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;CAFFE_MODELS = <span class="stringliteral">&quot;~/caffe2/caffe2/python/models&quot;</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment"># Some sample images you can try, or use any URL to a regular image.</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Whole-Lemon.jpg/1235px-Whole-Lemon.jpg&quot;</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://upload.wikimedia.org/wikipedia/commons/7/7b/Orange-Whole-%26-Split.jpg&quot;</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://upload.wikimedia.org/wikipedia/commons/a/ac/Pretzel.jpg&quot;</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment"># IMAGE_LOCATION = &quot;https://cdn.pixabay.com/photo/2015/02/10/21/28/flower-631765_1280.jpg&quot;</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;IMAGE_LOCATION = <span class="stringliteral">&quot;images/flower.jpg&quot;</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment"># What model are we using?</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">#    Format below is the model&#39;s: &lt;folder, INIT_NET, predict_net, mean, input image size&gt;</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">#    You can switch &#39;squeezenet&#39; out with &#39;bvlc_alexnet&#39;, &#39;bvlc_googlenet&#39; or others that you have downloaded</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;MODEL = <span class="stringliteral">&#39;squeezenet&#39;</span>, <span class="stringliteral">&#39;init_net.pb&#39;</span>, <span class="stringliteral">&#39;predict_net.pb&#39;</span>, <span class="stringliteral">&#39;ilsvrc_2012_mean.npy&#39;</span>, 227</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"># codes - these help decypher the output and source from a list from ImageNet&#39;s object codes </span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">#    to provide an result like &quot;tabby cat&quot; or &quot;lemon&quot; depending on what&#39;s in the picture </span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">#   you submit to the CNN.</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;codes =  <span class="stringliteral">&quot;https://gist.githubusercontent.com/aaronmarkham/cd3a6b6ac071eca6f7b4a6e40e6038aa/raw/9edb4038a37da6b5a44c3b5bc52e448ff09bfe5b/alexnet_codes&quot;</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;print(<span class="stringliteral">&quot;Config set!&quot;</span>)</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment"># ### Setup paths</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"># With the configs set, we can now load the mean file (if it exists), as well as the predict net and the init net.</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"># In[3]:</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment"># set paths and variables from model choice and prep image</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;CAFFE_MODELS = os.path.expanduser(CAFFE_MODELS)</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment"># mean can be 128 or custom based on the model</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment"># gives better results to remove the colors found in all of the training images</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;MEAN_FILE = os.path.join(CAFFE_MODELS, MODEL[0], MODEL[3])</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(MEAN_FILE):</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    print(<span class="stringliteral">&quot;No mean file found!&quot;</span>)</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    mean = 128</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">print</span> (<span class="stringliteral">&quot;Mean file found!&quot;</span>)</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    mean = np.load(MEAN_FILE).mean(1).mean(1)</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    mean = mean[:, np.newaxis, np.newaxis]</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;print(<span class="stringliteral">&quot;mean was set to: &quot;</span>, mean)</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment"># some models were trained with different image sizes, this helps you calibrate your image</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;INPUT_IMAGE_SIZE = MODEL[4]</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment"># make sure all of the files are around...</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;INIT_NET = os.path.join(CAFFE_MODELS, MODEL[0], MODEL[1])</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;PREDICT_NET = os.path.join(CAFFE_MODELS, MODEL[0], MODEL[2])</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment"># Check to see if the files exist</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(INIT_NET):</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    print(<span class="stringliteral">&quot;WARNING: &quot;</span> + INIT_NET + <span class="stringliteral">&quot; not found!&quot;</span>)</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(PREDICT_NET):</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        print(<span class="stringliteral">&quot;WARNING: &quot;</span> + PREDICT_NET + <span class="stringliteral">&quot; not found!&quot;</span>)</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        print(<span class="stringliteral">&quot;All needed files found!&quot;</span>)</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        </div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment"># ### Image Preprocessing</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment"># Now that we have our inputs specified and verified the existance of the input network, we can load the image and pre-processing the image for ingestion into a Caffe2 convolutional neural network! This is a very important step as the trained CNN requires a specifically sized input image whose values are from a particular distribution.</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment"># In[4]:</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"># Function to crop the center cropX x cropY pixels from the input image</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="keyword">def </span>crop_center(img,cropx,cropy):</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    y,x,c = img.shape</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    startx = x//2-(cropx//2)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    starty = y//2-(cropy//2)    </div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">return</span> img[starty:starty+cropy,startx:startx+cropx]</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment"># Function to rescale the input image to the desired height and/or width. This function will preserve</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">#   the aspect ratio of the original image while making the image the correct scale so we can retrieve</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">#   a good center crop. This function is best used with center crop to resize any size input images into</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">#   specific sized images that our model can use.</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="keyword">def </span>rescale(img, input_height, input_width):</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="comment"># Get original aspect ratio</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    aspect = img.shape[1]/float(img.shape[0])</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    if(aspect&gt;1):</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="comment"># landscape orientation - wide image</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        res = int(aspect * input_height)</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        imgScaled = skimage.transform.resize(img, (input_width, res))</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    if(aspect&lt;1):</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="comment"># portrait orientation - tall image</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        res = int(input_width/aspect)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        imgScaled = skimage.transform.resize(img, (res, input_height))</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    if(aspect == 1):</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        imgScaled = skimage.transform.resize(img, (input_width, input_height))</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordflow">return</span> imgScaled</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment"># Load the image as a 32-bit float</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">#    Note: skimage.io.imread returns a HWC ordered RGB image of some size</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;img = skimage.img_as_float(skimage.io.imread(IMAGE_LOCATION)).astype(np.float32)</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;print(<span class="stringliteral">&quot;Original Image Shape: &quot;</span> , img.shape)</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment"># Rescale the image to comply with our desired input size. This will not make the image 227x227</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">#    but it will make either the height or width 227 so we can get the ideal center crop.</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;img = rescale(img, INPUT_IMAGE_SIZE, INPUT_IMAGE_SIZE)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;print(<span class="stringliteral">&quot;Image Shape after rescaling: &quot;</span> , img.shape)</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;pyplot.figure()</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;pyplot.imshow(img)</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;pyplot.title(<span class="stringliteral">&#39;Rescaled image&#39;</span>)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment"># Crop the center 227x227 pixels of the image so we can feed it to our model</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;img = crop_center(img, INPUT_IMAGE_SIZE, INPUT_IMAGE_SIZE)</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;print(<span class="stringliteral">&quot;Image Shape after cropping: &quot;</span> , img.shape)</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;pyplot.figure()</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;pyplot.imshow(img)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;pyplot.title(<span class="stringliteral">&#39;Center Cropped&#39;</span>)</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment"># switch to CHW (HWC --&gt; CHW)</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;img = img.swapaxes(1, 2).swapaxes(0, 1)</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;print(<span class="stringliteral">&quot;CHW Image Shape: &quot;</span> , img.shape)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;pyplot.figure()</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3):</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="comment"># For some reason, pyplot subplot follows Matlab&#39;s indexing</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment"># convention (starting with 1). Well, we&#39;ll just follow it...</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    pyplot.subplot(1, 3, i+1)</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    pyplot.imshow(img[i])</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    pyplot.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    pyplot.title(<span class="stringliteral">&#39;RGB channel %d&#39;</span> % (i+1))</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment"># switch to BGR (RGB --&gt; BGR)</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;img = img[(2, 1, 0), :, :]</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment"># remove mean for better results</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;img = img * 255 - mean</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment"># add batch size axis which completes the formation of the NCHW shaped input that we want</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;img = img[np.newaxis, :, :, :].astype(np.float32)</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;print(<span class="stringliteral">&quot;NCHW image (ready to be used as input): &quot;</span>, img.shape)</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment"># ### Prepare the CNN and run the net!</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment"># Now that the image is ready to be ingested by the CNN, let&#39;s open the protobufs, load them into the workspace, and run the net. </span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment"># In[5]:</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment"># Read the contents of the input protobufs into local variables</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;with open(INIT_NET) <span class="keyword">as</span> f:</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    init_net = f.read()</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;with open(PREDICT_NET) <span class="keyword">as</span> f:</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    predict_net = f.read()</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment"># Initialize the predictor from the input protobufs</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;p = workspace.Predictor(init_net, predict_net)</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment"># Run the net and return prediction</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;results = p.run({<span class="stringliteral">&#39;data&#39;</span>: img})</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment"># Turn it into something we can play with and examine which is in a multi-dimensional array</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;results = np.asarray(results)</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;print(<span class="stringliteral">&quot;results shape: &quot;</span>, results.shape)</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="comment"># Quick way to get the top-1 prediction result</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment"># Squeeze out the unnecessary axis. This returns a 1-D array of length 1000</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;preds = np.squeeze(results)</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment"># Get the prediction and the confidence by finding the maximum value and index of maximum value in preds array</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;curr_pred, curr_conf = max(enumerate(preds), key=operator.itemgetter(1))</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;print(<span class="stringliteral">&quot;Prediction: &quot;</span>, curr_pred)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;print(<span class="stringliteral">&quot;Confidence: &quot;</span>, curr_conf)</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment"># ### Process Results</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment"># Recall ImageNet is a 1000 class dataset and observe that it is no coincidence that the third axis of results is length 1000. This axis is holding the probability for each category in the pre-trained model. So when you look at the results array at a specific index, the number can be interpreted as the probability that the input belongs to the class corresponding to that index. Now that we have run the predictor and collected the results, we can interpret them by matching them to their corresponding english labels.</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment"># In[6]:</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment"># the rest of this is digging through the results </span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;results = np.delete(results, 1)</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;index = 0</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;highest = 0</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;arr = np.empty((0,2), dtype=object)</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;arr[:,0] = int(10)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;arr[:,1:] = float(10)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keywordflow">for</span> i, r <span class="keywordflow">in</span> enumerate(results):</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment"># imagenet index begins with 1!</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    i=i+1</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    arr = np.append(arr, np.array([[i,r]]), axis=0)</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">if</span> (r &gt; highest):</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        highest = r</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        index = i </div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment"># top N results</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;N = 5</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;topN = sorted(arr, key=<span class="keyword">lambda</span> x: x[1], reverse=<span class="keyword">True</span>)[:N]</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;print(<span class="stringliteral">&quot;Raw top {} results: {}&quot;</span>.format(N,topN))</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment"># Isolate the indexes of the top-N most likely classes</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;topN_inds = [int(x[0]) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> topN]</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;print(<span class="stringliteral">&quot;Top {} classes in order: {}&quot;</span>.format(N,topN_inds))</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment"># Now we can grab the code list and create a class Look Up Table</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;response = urllib2.urlopen(codes)</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;class_LUT = []</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordflow">for</span> line <span class="keywordflow">in</span> response:</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    code, result = line.partition(<span class="stringliteral">&quot;:&quot;</span>)[::2]</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    code = code.strip()</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    result = result.replace(<span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="keywordflow">if</span> code.isdigit():</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        class_LUT.append(result.split(<span class="stringliteral">&quot;,&quot;</span>)[0][1:])</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        </div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment"># For each of the top-N results, associate the integer result with an actual class</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordflow">for</span> n <span class="keywordflow">in</span> topN:</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    print(<span class="stringliteral">&quot;Model predicts &#39;{}&#39; with {}% confidence&quot;</span>.format(class_LUT[int(n[0])],float(<span class="stringliteral">&quot;{0:.2f}&quot;</span>.format(n[1]*100))))</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment"># ### Feeding Larger Batches</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment"># Above is an example of how to feed one image at a time. We can achieve higher throughput if we feed multiple images at a time in a single batch. Recall, the data fed into the classifier is in &#39;NCHW&#39; order, so to feed multiple images, we will expand the &#39;N&#39; axis.</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment"># In[7]:</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment"># List of input images to be fed</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;images = [<span class="stringliteral">&quot;images/cowboy-hat.jpg&quot;</span>,</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;            <span class="stringliteral">&quot;images/cell-tower.jpg&quot;</span>,</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            <span class="stringliteral">&quot;images/Ducreux.jpg&quot;</span>,</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            <span class="stringliteral">&quot;images/pretzel.jpg&quot;</span>,</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="stringliteral">&quot;images/orangutan.jpg&quot;</span>,</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            <span class="stringliteral">&quot;images/aircraft-carrier.jpg&quot;</span>,</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;            <span class="stringliteral">&quot;images/cat.jpg&quot;</span>]</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment"># Allocate space for the batch of formatted images</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;NCHW_batch = np.zeros((len(images),3,227,227))</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="keywordflow">print</span> (<span class="stringliteral">&quot;Batch Shape: &quot;</span>,NCHW_batch.shape)</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment"># For each of the images in the list, format it and place it in the batch</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordflow">for</span> i,curr_img <span class="keywordflow">in</span> enumerate(images):</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    img = skimage.img_as_float(skimage.io.imread(curr_img)).astype(np.float32)</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    img = rescale(img, 227, 227)</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    img = crop_center(img, 227, 227)</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    img = img.swapaxes(1, 2).swapaxes(0, 1)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    img = img[(2, 1, 0), :, :]</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    img = img * 255 - mean</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    NCHW_batch[i] = img</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;print(<span class="stringliteral">&quot;NCHW image (ready to be used as input): &quot;</span>, NCHW_batch.shape)</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment"># Run the net on the batch</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;results = p.run([NCHW_batch.astype(np.float32)])</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment"># Turn it into something we can play with and examine which is in a multi-dimensional array</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;results = np.asarray(results)</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment"># Squeeze out the unnecessary axis</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;preds = np.squeeze(results)</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;print(<span class="stringliteral">&quot;Squeezed Predictions Shape, with batch size {}: {}&quot;</span>.format(len(images),preds.shape))</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment"># Describe the results</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="keywordflow">for</span> i,pred <span class="keywordflow">in</span> enumerate(preds):</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    print(<span class="stringliteral">&quot;Results for: &#39;{}&#39;&quot;</span>.format(images[i]))</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment"># Get the prediction and the confidence by finding the maximum value </span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">#   and index of maximum value in preds array</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    curr_pred, curr_conf = max(enumerate(pred), key=operator.itemgetter(1))</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    print(<span class="stringliteral">&quot;\tPrediction: &quot;</span>, curr_pred)</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    print(<span class="stringliteral">&quot;\tClass Name: &quot;</span>, class_LUT[int(curr_pred)])</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    print(<span class="stringliteral">&quot;\tConfidence: &quot;</span>, curr_conf)</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="ttc" id="namespacecaffe2_1_1python_html"><div class="ttname"><a href="namespacecaffe2_1_1python.html">caffe2.python</a></div><div class="ttdef"><b>Definition:</b> <a href="python_2____init_____8py_source.html#l00001">__init__.py:1</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Mar 24 2018 13:03:34 for Caffe2 - Python API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
<div class="footerContainer">
  <div id="footer_wrap" class="wrapper footerWrapper">
    <div class="footerBlocks">
      <div id="fb_oss" class="footerSection fbOpenSourceFooter">
          <svg class="facebookOSSLogoSvg" viewBox="0 0 1133.9 1133.9" x="0px" y="0px" height=50 width=50>
            <g>
              <path class="logoRing outerRing" d="M 498.3 3.7 c 153.6 88.9 307.3 177.7 461.1 266.2 c 7.6 4.4 10.3 9.1 10.3 17.8 c -0.3 179.1 -0.2 358.3 0 537.4 c 0 8.1 -2.4 12.8 -9.7 17.1 c -154.5 88.9 -308.8 178.1 -462.9 267.5 c -9 5.2 -15.5 5.3 -24.6 0.1 c -153.9 -89.2 -307.9 -178 -462.1 -266.8 C 3 838.8 0 833.9 0 825.1 c 0.3 -179.1 0.2 -358.3 0 -537.4 c 0 -8.6 2.6 -13.6 10.2 -18 C 164.4 180.9 318.4 92 472.4 3 C 477 -1.5 494.3 -0.7 498.3 3.7 Z M 48.8 555.3 c 0 79.9 0.2 159.9 -0.2 239.8 c -0.1 10 3 15.6 11.7 20.6 c 137.2 78.8 274.2 157.8 411 237.3 c 9.9 5.7 17 5.7 26.8 0.1 c 137.5 -79.8 275.2 -159.2 412.9 -238.5 c 7.4 -4.3 10.5 -8.9 10.5 -17.8 c -0.3 -160.2 -0.3 -320.5 0 -480.7 c 0 -8.8 -2.8 -13.6 -10.3 -18 C 772.1 218 633.1 137.8 494.2 57.4 c -6.5 -3.8 -11.5 -4.5 -18.5 -0.5 C 336.8 137.4 197.9 217.7 58.8 297.7 c -7.7 4.4 -10.2 9.2 -10.2 17.9 C 48.9 395.5 48.8 475.4 48.8 555.3 Z" />
              <path class="logoRing middleRing" d="M 184.4 555.9 c 0 -33.3 -1 -66.7 0.3 -100 c 1.9 -48 24.1 -86 64.7 -110.9 c 54.8 -33.6 110.7 -65.5 167 -96.6 c 45.7 -25.2 92.9 -24.7 138.6 1 c 54.4 30.6 108.7 61.5 162.2 93.7 c 44 26.5 67.3 66.8 68 118.4 c 0.9 63.2 0.9 126.5 0 189.7 c -0.7 50.6 -23.4 90.7 -66.6 116.9 c -55 33.4 -110.8 65.4 -167.1 96.5 c -43.4 24 -89 24.2 -132.3 0.5 c -57.5 -31.3 -114.2 -64 -170 -98.3 c -41 -25.1 -62.9 -63.7 -64.5 -112.2 C 183.5 621.9 184.3 588.9 184.4 555.9 Z M 232.9 556.3 c 0 29.5 0.5 59.1 -0.1 88.6 c -0.8 39.2 16.9 67.1 50.2 86.2 c 51.2 29.4 102.2 59.2 153.4 88.4 c 31.4 17.9 63.6 18.3 95 0.6 c 53.7 -30.3 107.1 -61.2 160.3 -92.5 c 29.7 -17.5 45 -44.5 45.3 -78.8 c 0.6 -61.7 0.5 -123.5 0 -185.2 c -0.3 -34.4 -15.3 -61.5 -44.9 -79 C 637.7 352.6 583 320.8 527.9 290 c -27.5 -15.4 -57.2 -16.1 -84.7 -0.7 c -56.9 31.6 -113.4 64 -169.1 97.6 c -26.4 15.9 -40.7 41.3 -41.1 72.9 C 232.6 491.9 232.9 524.1 232.9 556.3 Z" />
              <path class="logoRing innerRing" d="M 484.9 424.4 c 69.8 -2.8 133.2 57.8 132.6 132 C 617 630 558.5 688.7 484.9 689.1 c -75.1 0.4 -132.6 -63.6 -132.7 -132.7 C 352.1 485 413.4 421.5 484.9 424.4 Z M 401.3 556.7 c -3.4 37.2 30.5 83.6 83 84.1 c 46.6 0.4 84.8 -37.6 84.9 -84 c 0.1 -46.6 -37.2 -84.4 -84.2 -84.6 C 432.2 472.1 397.9 518.3 401.3 556.7 Z" />
            </g>
          </svg>
        <h2>Facebook Open Source</h2>
      </div>
      <div class="footerSection">
        <a class="footerLink" href="https://code.facebook.com/projects/" target="_blank">Open Source Projects</a>
        <a class="footerLink" href="https://github.com/facebook/" target="_blank">GitHub</a>
        <a class="footerLink" href="https://twitter.com/fbOpenSource" target="_blank">Twitter</a>
      </div>
      <div class="footerSection rightAlign">
        <a class="footerLink" href="https://github.com/caffe2/caffe2" target="_blank">Contribute to this project on GitHub</a>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript" src="/js/jekyll-link-anchors.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '{{ site.gacode }}', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
